import React, { useState, useEffect, useRef } from 'react';

const FontImport = () => (
  <style>
    {`
      @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
      body { font-family: 'JetBrains Mono', monospace; background-color: #0b0f19; color: #e2e8f0; margin: 0; }
      
      .thinking-dots::after {
        content: '.';
        animation: dots 1.5s steps(5, end) infinite;
      }
      @keyframes dots {
        0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
        40% { color: #00f0ff; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
        60% { text-shadow: .25em 0 0 #00f0ff, .5em 0 0 rgba(0,0,0,0); }
        80%, 100% { text-shadow: .25em 0 0 #00f0ff, .5em 0 0 #00f0ff; }
      }
    `}
  </style>
);

// Простой рендер Markdown для MVP (жирный шрифт и переносы строк)
const formatMarkdown = (text) => {
  if (!text) return null;
  const parts = text.split(/(\*\*.*?\*\*|\n)/g);
  return parts.map((part, i) => {
    if (part === '\n') return <br key={i} />;
    if (part.startsWith('**') && part.endsWith('**')) {
      return <strong key={i} className="text-white">{part.slice(2, -2)}</strong>;
    }
    // Простая обработка элементов списка (начинающихся с * или -)
    if (part.trim().match(/^[-*]\s/)) {
      return <span key={i} className="block ml-4 mb-1 text-[#00f0ff]">▹ {part.replace(/^[-*]\s/, '')}</span>;
    }
    return part;
  });
};

export default function App() {
  const [url, setUrl] = useState('');
  const [stage, setStage] = useState('input');
  const [progress, setProgress] = useState(0);
  const [messages, setMessages] = useState([]);
  const [inputMessage, setInputMessage] = useState('');
  
  const [siteContent, setSiteContent] = useState('');
  const [error, setError] = useState(null);
  const [isThinking, setIsThinking] = useState(false);

  // Настройки
  const [showSettings, setShowSettings] = useState(false);
  const [apiKey, setApiKey] = useState(() => localStorage.getItem('webmind_api_key') || '');

  const messagesEndRef = useRef(null);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, isThinking]);

  const saveApiKey = (key) => {
    setApiKey(key);
    localStorage.setItem('webmind_api_key', key);
  };

  const startScanning = async () => {
    if (!url.trim()) return;
    setStage('scanning');
    setProgress(0);
    setError(null);

    const progressInterval = setInterval(() => {
      setProgress((prev) => (prev < 90 ? prev + Math.floor(Math.random() * 10) + 2 : prev));
    }, 300);

    try {
      const response = await fetch('https://r.jina.ai/' + url);
      if (!response.ok) throw new Error(`Ошибка HTTP: ${response.status}`);
      
      const text = await response.text();
      setSiteContent(text);

      clearInterval(progressInterval);
      setProgress(100);

      setTimeout(() => {
        setStage('chat');
        setMessages([
          { sender: 'bot', text: `Контент сайта извлечен (${text.length} симв.). Задайте вопрос по материалу.` }
        ]);
      }, 800);

    } catch (err) {
      clearInterval(progressInterval);
      setStage('input');
      setError('Ошибка доступа: ' + err.message);
    }
  };

  const askAI = async (userText) => {
    setIsThinking(true);
    try {
      const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: 'google/gemini-1.5-flash', // Быстрая модель по умолчанию
          messages: [
            { 
              role: 'system', 
              content: `Ты эксперт-помощник. Отвечай на вопросы пользователя, опираясь строго на этот контекст с сайта:\n\n${siteContent.substring(0, 15000)}` 
            },
            { role: 'user', content: userText }
          ]
        })
      });
      
      const data = await response.json();
      if (data.error) throw new Error(data.error.message);
      
      const aiResponse = data.choices[0].message.content;
      setMessages((prev) => [...prev, { sender: 'bot', text: aiResponse }]);
    } catch (err) {
      setMessages((prev) => [...prev, { sender: 'bot', text: `**Ошибка API:**\n${err.message}` }]);
    } finally {
      setIsThinking(false);
    }
  };

  const sendMessage = async (e) => {
    e.preventDefault();
    if (!inputMessage.trim() || isThinking) return;

    const userText = inputMessage;
    setMessages((prev) => [...prev, { sender: 'user', text: userText }]);
    setInputMessage('');

    if (!apiKey) {
      setMessages((prev) => [...prev, { sender: 'bot', text: 'Укажите API ключ в настройках (⚙️) для генерации ответов.' }]);
      return;
    }

    await askAI(userText);
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-4 relative">
      <FontImport />

      {/* HEADER & SETTINGS */}
      <header className="absolute top-8 left-8 right-8 flex justify-between items-center z-10">
        <h1 className="text-2xl font-bold tracking-widest text-[#00f0ff] drop-shadow-[0_0_8px_rgba(0,240,255,0.8)]">
          WEBMIND<span className="animate-pulse">_</span>
        </h1>
        <button 
          onClick={() => setShowSettings(true)}
          className="text-gray-400 hover:text-[#00f0ff] transition-colors p-2"
        >
          {/* Иконка шестеренки */}
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
      </header>

      {/* МОДАЛЬНОЕ ОКНО НАСТРОЕК */}
      {showSettings && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm animate-fade-in">
          <div className="bg-[#111827] border border-[#00f0ff]/50 p-6 rounded-xl w-full max-w-md shadow-[0_0_30px_rgba(0,240,255,0.1)]">
            <h2 className="text-[#00f0ff] text-xl mb-4 uppercase tracking-widest font-bold">Настройки API</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-gray-400 text-sm mb-2">OpenRouter API Key:</label>
                <input
                  type="password"
                  value={apiKey}
                  onChange={(e) => saveApiKey(e.target.value)}
                  placeholder="sk-or-v1-..."
                  className="w-full bg-[#0b0f19] border border-gray-700 focus:border-[#00f0ff] rounded px-4 py-2 text-sm outline-none transition-colors"
                />
              </div>
              <div className="flex justify-end pt-2">
                <button 
                  onClick={() => setShowSettings(false)}
                  className="px-6 py-2 bg-[#00f0ff] text-[#0b0f19] font-bold rounded hover:shadow-[0_0_10px_#00f0ff] transition-all"
                >
                  Готово
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* СТЕЙТ 1: ВВОД URL */}
      {stage === 'input' && (
        <div className="w-full max-w-xl flex flex-col items-center z-0">
          <input
            type="url"
            placeholder="https://example.com"
            value={url}
            onChange={(e) => setUrl(e.target.value)}
            className={`w-full bg-[#111827] border ${error ? 'border-[#ff003c]' : 'border-gray-700'} focus:border-[#00f0ff] focus:ring-1 focus:ring-[#00f0ff] rounded-md px-6 py-4 text-lg outline-none transition-all shadow-inner`}
            autoFocus
          />
          {error && <div className="mt-4 text-[#ff003c] text-sm tracking-wider font-bold animate-pulse text-center">[!] {error}</div>}
          <button
            onClick={startScanning}
            disabled={!url.trim()}
            className="mt-8 px-10 py-4 bg-transparent border-2 border-[#00f0ff] text-[#00f0ff] font-bold text-lg rounded-md uppercase tracking-wider hover:bg-[#00f0ff] hover:text-[#0b0f19] transition-all duration-300 disabled:opacity-50"
          >
            Изучить сайт
          </button>
        </div>
      )}

      {/* СТЕЙТ 2: СКАНИРОВАНИЕ */}
      {stage === 'scanning' && (
        <div className="w-full max-w-xl flex flex-col items-center">
          <p className="text-[#00f0ff] mb-4 text-sm uppercase tracking-widest">Извлечение данных: {progress}%</p>
          <div className="w-full h-2 bg-gray-800 rounded-full overflow-hidden border border-gray-700">
            <div className="h-full bg-[#00f0ff] transition-all duration-300 ease-out" style={{ width: `${progress}%` }} />
          </div>
        </div>
      )}

      {/* СТЕЙТ 3: ЧАТ */}
      {stage === 'chat' && (
        <div className="w-full max-w-3xl h-[75vh] bg-[#111827] border border-gray-800 rounded-xl flex flex-col shadow-2xl mt-12">
          <div className="flex-1 overflow-y-auto p-6 space-y-6">
            {messages.map((msg, idx) => (
              <div key={idx} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[85%] px-5 py-3 rounded-lg text-sm leading-relaxed ${
                  msg.sender === 'user' 
                    ? 'bg-gray-800 text-gray-100 border border-gray-700' 
                    : 'bg-[#00f0ff]/10 border border-[#00f0ff]/30 text-[#e2e8f0]'
                }`}>
                  {formatMarkdown(msg.text)}
                </div>
              </div>
            ))}
            
            {/* АНИМАЦИЯ ОЖИДАНИЯ */}
            {isThinking && (
              <div className="flex justify-start">
                <div className="max-w-[80%] px-5 py-3 rounded-lg text-sm bg-[#00f0ff]/5 border border-[#00f0ff]/20 text-[#00f0ff]">
                  <span className="opacity-80">Анализирую данные</span>
                  <span className="thinking-dots"></span>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          <form onSubmit={sendMessage} className="p-4 border-t border-gray-800 bg-[#0b0f19] rounded-b-xl flex gap-3">
            <input
              type="text"
              placeholder="Спроси что-нибудь о контенте..."
              value={inputMessage}
              onChange={(e) => setInputMessage(e.target.value)}
              disabled={isThinking}
              className="flex-1 bg-transparent border border-gray-700 focus:border-[#00f0ff] rounded-md px-4 py-3 outline-none text-sm transition-colors disabled:opacity-50"
            />
            <button 
              type="submit"
              disabled={!inputMessage.trim() || isThinking}
              className="px-6 py-3 bg-[#00f0ff] text-[#0b0f19] font-bold rounded-md hover:shadow-[0_0_15px_#00f0ff] transition-all disabled:opacity-50"
            >
              &gt;
            </button>
          </form>
        </div>
      )}
    </div>
  );
}
