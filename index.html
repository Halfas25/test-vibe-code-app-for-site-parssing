<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebMind - AI Web Scanner</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#0b0f19] text-[#e2e8f0] m-0">
  
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const FontImport = () => (
      <style>
        {`
          @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
          body { font-family: 'JetBrains Mono', monospace; }
          
          .thinking-dots::after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
          }
          @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: #00f0ff; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 #00f0ff, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 #00f0ff, .5em 0 0 #00f0ff; }
          }

          /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∞–≤—Ç–æ-–∫–æ–Ω—Å–ø–µ–∫—Ç–∞ */
          .summary-card {
            background-color: rgba(0, 240, 255, 0.05);
            border: 2px solid #00f0ff;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.15);
            color: #e2e8f0;
          }
        `}
      </style>
    );

    const formatInline = (text) => {
      const parts = text.split(/(\*\*.*?\*\*)/g);
      return parts.map((part, i) => {
        if (part.startsWith('**') && part.endsWith('**')) {
          return <strong key={i} className="text-white">{part.slice(2, -2)}</strong>;
        }
        return part;
      });
    };

    const formatMarkdown = (text) => {
      if (!text) return null;
      const lines = text.split('\n');
      return lines.map((line, i) => {
        const trimmed = line.trim();
        if (trimmed === '---') {
          return <hr key={i} className="border-[#00f0ff]/30 my-5 shadow-[0_0_10px_rgba(0,240,255,0.2)]" />;
        }
        if (trimmed.startsWith('# ')) {
          return <h1 key={i} className="text-xl font-bold text-[#00f0ff] mb-4 mt-2 drop-shadow-[0_0_5px_rgba(0,240,255,0.5)]">{formatInline(trimmed.slice(2))}</h1>;
        }
        if (trimmed.startsWith('## ')) {
          return <h2 key={i} className="text-lg font-bold text-[#e2e8f0] mb-3 mt-4">{formatInline(trimmed.slice(3))}</h2>;
        }
        if (trimmed.startsWith('### ')) {
          return <h3 key={i} className="text-md font-bold text-[#00f0ff] mb-2 mt-3">{formatInline(trimmed.slice(4))}</h3>;
        }
        if (trimmed.startsWith('> ')) {
          return <blockquote key={i} className="border-l-4 border-[#00f0ff] bg-[#00f0ff]/10 p-4 rounded-r italic text-gray-200 my-4 shadow-inner">{formatInline(trimmed.slice(2))}</blockquote>;
        }
        return <div key={i} className="mb-2 leading-relaxed">{formatInline(line)}</div>;
      });
    };

    const isBotBlocked = (text) => {
      if (!text) return true;
      const lower = text.toLowerCase();
      return lower.includes('w.wiki/4wjs') || 
             lower.includes('just a moment...') || 
             (lower.includes('enable javascript') && lower.includes('cloudflare')) ||
             lower.includes('attention required! | cloudflare') ||
             lower.includes('please wait while your request is being verified');
    };

    const parseApiError = (errMessage) => {
      if (errMessage.includes('User not found') || errMessage.includes('401')) {
        return '–í–∞—à API-–∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ —É–¥–∞–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á –Ω–∞ OpenRouter –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (‚öôÔ∏è).';
      }
      return errMessage;
    };

    function App() {
      const [url, setUrl] = useState('');
      const [stage, setStage] = useState('input');
      const [progress, setProgress] = useState(0);
      const [messages, setMessages] = useState([]);
      const [inputMessage, setInputMessage] = useState('');
      
      const [siteContent, setSiteContent] = useState('');
      const [error, setError] = useState(null);
      const [isThinking, setIsThinking] = useState(false);
      const [isGeneratingSummary, setIsGeneratingSummary] = useState(false);

      const [showSettings, setShowSettings] = useState(false);
      
      const defaultApiKey = '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';
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('webmind_api_key') || defaultApiKey);

      const messagesEndRef = useRef(null);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages, isThinking, isGeneratingSummary]);

      const saveApiKey = (key) => {
        setApiKey(key);
        localStorage.setItem('webmind_api_key', key);
      };

      const generateAutoSummary = async (text) => {
        setIsGeneratingSummary(true);
        try {
          const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: 'google/gemma-2-9b-it:free',
              messages: [
                { 
                  role: 'system', 
                  content: `–¢—ã ‚Äî –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò-–∞–Ω–∞–ª–∏—Ç–∏–∫. –û–ø–∏—Ä–∞–π—Å—è —Å—Ç—Ä–æ–≥–æ –Ω–∞ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç:\n\n${text.substring(0, 15000)}` 
                },
                { 
                  role: 'user', 
                  content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç —Å–∞–π—Ç –∏ –≤—ã–¥–∞–π –∫—Ä–∞—Ç–∫–∏–π, —Å—Ç–∏–ª—å–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –≤—ã–¥–µ–ª–∏ 5 –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤. –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å –∫—Ä–∞—Ç–∫–∏–π –≤–µ—Ä–¥–∏–∫—Ç` 
                }
              ]
            })
          });
          
          const data = await response.json();
          if (data.error) throw new Error(data.error.message);
          
          const aiResponse = data.choices[0].message.content;
          setMessages([{ sender: 'bot', text: aiResponse, isSummary: true }]);
        } catch (err) {
          setMessages([{ sender: 'bot', text: `**–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞:**\n${parseApiError(err.message)}` }]);
        } finally {
          setIsGeneratingSummary(false);
        }
      };

      const startScanning = async () => {
        const trimmedUrl = url.trim();
        
        if (!trimmedUrl.startsWith('http://') && !trimmedUrl.startsWith('https://')) {
          setError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https:// (API-–∫–ª—é—á –≤–≤–æ–¥–∏—Ç—Å—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö ‚öôÔ∏è)');
          return;
        }

        setStage('scanning');
        setProgress(0);
        setError(null);

        const progressInterval = setInterval(() => {
          setProgress((prev) => (prev < 90 ? prev + Math.floor(Math.random() * 10) + 2 : prev));
        }, 300);

        try {
          let cleanText = '';
          const isWikipedia = trimmedUrl.includes('wikipedia.org/wiki/');

          if (isWikipedia) {
            try {
              const urlObj = new URL(trimmedUrl);
              const title = urlObj.pathname.split('/wiki/')[1];
              const domain = urlObj.hostname;
              const wikiApiUrl = `https://${domain}/w/api.php?action=query&prop=extracts&explaintext=1&titles=${title}&format=json&origin=*`;
              
              const response = await fetch(wikiApiUrl);
              if (response.ok) {
                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                if (pageId !== '-1' && pages[pageId].extract) {
                  cleanText = pages[pageId].extract;
                }
              }
            } catch (e) {
              console.warn('Wikipedia API failed, using fallback...');
            }
          }

          if (!cleanText || cleanText.trim() === '') {
            const encodedUrl = encodeURIComponent(trimmedUrl);
            
            try {
              const response1 = await fetch('https://r.jina.ai/' + trimmedUrl, {
                headers: { 'Accept': 'application/json', 'X-Return-Format': 'markdown' }
              });
              if (response1.ok) {
                const data1 = await response1.json();
                const text1 = data1.data?.content || data1.content || data1.text || '';
                if (!isBotBlocked(text1)) cleanText = text1;
              }
            } catch (err) { console.warn("Jina failed"); }

            if (!cleanText) {
              try {
                const response2 = await fetch('https://api.allorigins.win/raw?url=' + encodedUrl);
                if (response2.ok) {
                  const rawHtml = await response2.text();
                  const doc = new DOMParser().parseFromString(rawHtml, 'text/html');
                  doc.querySelectorAll('script, style, svg, noscript, iframe, nav, footer').forEach(el => el.remove());
                  const text2 = (doc.body ? doc.body.textContent : doc.textContent).replace(/\s+/g, ' ').trim();
                  if (!isBotBlocked(text2)) cleanText = text2;
                }
              } catch (err) { console.warn("AllOrigins Raw failed"); }
            }
          }

          if (!cleanText || cleanText.trim() === '') {
            throw new Error('–°–∞–π—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –¥–æ—Å—Ç—É–ø (Anti-Bot) –∏–ª–∏ –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.');
          }

          setSiteContent(cleanText);
          clearInterval(progressInterval);
          setProgress(100);

          setTimeout(() => {
            setStage('chat');
            if (apiKey) {
              generateAutoSummary(cleanText);
            } else {
              setMessages([
                { sender: 'bot', text: `–ö–æ–Ω—Ç–µ–Ω—Ç –∏–∑–≤–ª–µ—á–µ–Ω. –£–∫–∞–∂–∏—Ç–µ API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (‚öôÔ∏è) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞.` }
              ]);
            }
          }, 800);

        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏:", error);
          clearInterval(progressInterval);
          setStage('input');
          setError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–æ–π—Ç–∏ –∑–∞—â–∏—Ç—É —Å–∞–π—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL.');
        }
      };

      const askAI = async (userText) => {
        setIsThinking(true);
        try {
          const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: 'google/gemma-2-9b-it:free',
              messages: [
                { 
                  role: 'system', 
                  content: `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç-–ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫—Ä–∞—Ç–∫–æ –∏ –µ–º–∫–æ, –æ–ø–∏—Ä–∞—è—Å—å —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç —Å–∞–π—Ç–∞:\n\n${siteContent.substring(0, 15000)}` 
                },
                { role: 'user', content: userText }
              ]
            })
          });
          
          const data = await response.json();
          if (data.error) throw new Error(data.error.message);
          
          const aiResponse = data.choices[0].message.content;
          setMessages((prev) => [...prev, { sender: 'bot', text: aiResponse }]);
        } catch (err) {
          setMessages((prev) => [...prev, { sender: 'bot', text: `**–û—à–∏–±–∫–∞ API:**\n${parseApiError(err.message)}` }]);
        } finally {
          setIsThinking(false);
        }
      };

      const sendMessage = async (e) => {
        e.preventDefault();
        if (!inputMessage.trim() || isThinking || isGeneratingSummary) return;

        const userText = inputMessage;
        setMessages((prev) => [...prev, { sender: 'user', text: userText }]);
        setInputMessage('');

        if (!apiKey) {
          setMessages((prev) => [...prev, { sender: 'bot', text: '–£–∫–∞–∂–∏—Ç–µ API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (‚öôÔ∏è) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤.' }]);
          return;
        }

        await askAI(userText);
      };

      const resetApp = () => {
        setStage('input');
        setUrl('');
        setSiteContent('');
        setMessages([]);
        setError(null);
      };

      return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4 relative">
          <FontImport />

          <header className="absolute top-8 left-8 right-8 flex justify-between items-center z-10">
            <h1 
              className="text-2xl font-bold tracking-widest text-[#00f0ff] drop-shadow-[0_0_8px_rgba(0,240,255,0.8)] cursor-pointer"
              onClick={resetApp}
              title="–ù–∞ –≥–ª–∞–≤–Ω—É—é"
            >
              WEBMIND<span className="animate-pulse">_</span>
            </h1>
            
            <div className="flex items-center gap-4">
              {stage !== 'input' && (
                <button 
                  onClick={resetApp}
                  className="px-4 py-1.5 text-sm font-bold tracking-wider text-[#00f0ff] border border-[#00f0ff] rounded hover:bg-[#00f0ff] hover:text-[#0b0f19] transition-all hover:shadow-[0_0_10px_rgba(0,240,255,0.5)] uppercase"
                >
                  –û—á–∏—Å—Ç–∏—Ç—å
                </button>
              )}
              
              <button 
                onClick={() => setShowSettings(true)}
                className="text-gray-400 hover:text-[#00f0ff] transition-colors p-2"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </button>
            </div>
          </header>

          {showSettings && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm animate-fade-in">
              <div className="bg-[#111827] border border-[#00f0ff]/50 p-6 rounded-xl w-full max-w-md shadow-[0_0_30px_rgba(0,240,255,0.1)]">
                <h2 className="text-[#00f0ff] text-xl mb-4 uppercase tracking-widest font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-gray-400 text-sm mb-2">OpenRouter API Key:</label>
                    <input
                      type="password"
                      value={apiKey}
                      onChange={(e) => saveApiKey(e.target.value)}
                      placeholder="sk-or-v1-..."
                      className="w-full bg-[#0b0f19] border border-gray-700 focus:border-[#00f0ff] rounded px-4 py-2 text-sm outline-none transition-colors"
                    />
                  </div>
                  <div className="flex justify-end pt-2">
                    <button 
                      onClick={() => setShowSettings(false)}
                      className="px-6 py-2 bg-[#00f0ff] text-[#0b0f19] font-bold rounded hover:shadow-[0_0_10px_#00f0ff] transition-all"
                    >
                      –ì–æ—Ç–æ–≤–æ
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {stage === 'input' && (
            <div className="w-full max-w-xl flex flex-col items-center z-0 mt-16">
              <input
                type="url"
                placeholder="https://example.com"
                value={url}
                onChange={(e) => setUrl(e.target.value)}
                className={`w-full bg-[#111827] border ${error ? 'border-[#ff003c]' : 'border-gray-700'} focus:border-[#00f0ff] focus:ring-1 focus:ring-[#00f0ff] rounded-md px-6 py-4 text-lg outline-none transition-all shadow-inner`}
                autoFocus
              />
              {error && <div className="mt-4 text-[#ff003c] text-sm tracking-wider font-bold animate-pulse text-center">[!] {error}</div>}
              <button
                onClick={startScanning}
                disabled={!url.trim()}
                className="mt-8 px-10 py-4 bg-transparent border-2 border-[#00f0ff] text-[#00f0ff] font-bold text-lg rounded-md uppercase tracking-wider hover:bg-[#00f0ff] hover:text-[#0b0f19] transition-all duration-300 disabled:opacity-50"
              >
                –ò–∑—É—á–∏—Ç—å —Å–∞–π—Ç
              </button>
            </div>
          )}

          {stage === 'scanning' && (
            <div className="w-full max-w-xl flex flex-col items-center mt-16">
              <p className="text-[#00f0ff] mb-4 text-sm uppercase tracking-widest">–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö: {progress}%</p>
              <div className="w-full h-2 bg-gray-800 rounded-full overflow-hidden border border-gray-700">
                <div className="h-full bg-[#00f0ff] transition-all duration-300 ease-out" style={{ width: `${progress}%` }} />
              </div>
            </div>
          )}

          {stage === 'chat' && (
            <div className="w-full max-w-4xl h-[80vh] bg-[#111827] border border-gray-800 rounded-xl flex flex-col shadow-2xl mt-12">
              <div className="flex-1 overflow-y-auto p-6 space-y-6">
                
                {isGeneratingSummary && (
                  <div className="flex justify-start">
                    <div className="max-w-[80%] px-6 py-4 rounded-lg bg-[#00f0ff]/5 border border-[#00f0ff] shadow-[0_0_15px_rgba(0,240,255,0.2)] text-[#00f0ff] font-bold tracking-widest text-sm animate-pulse">
                      –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≤—ã–∂–∏–º–∫—É... üü©üü©üü©‚¨ú‚¨ú
                    </div>
                  </div>
                )}

                {messages.map((msg, idx) => (
                  <div key={idx} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[90%] px-6 py-4 rounded-lg text-sm ${
                      msg.sender === 'user' 
                        ? 'bg-gray-800 text-gray-100 border border-gray-700' 
                        : msg.isSummary 
                          ? 'summary-card' 
                          : 'bg-[#00f0ff]/10 border border-[#00f0ff]/30 text-[#e2e8f0]'
                    }`}>
                      {formatMarkdown(msg.text)}
                    </div>
                  </div>
                ))}
                
                {isThinking && (
                  <div className="flex justify-start">
                    <div className="max-w-[80%] px-5 py-3 rounded-lg text-sm bg-[#00f0ff]/5 border border-[#00f0ff]/20 text-[#00f0ff]">
                      <span className="opacity-80">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–ø—Ä–æ—Å</span>
                      <span className="thinking-dots"></span>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>

              <form onSubmit={sendMessage} className="p-4 border-t border-gray-800 bg-[#0b0f19] rounded-b-xl flex gap-3">
                <input
                  type="text"
                  placeholder="–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª—É..."
                  value={inputMessage}
                  onChange={(e) => setInputMessage(e.target.value)}
                  disabled={isThinking || isGeneratingSummary}
                  className="flex-1 bg-transparent border border-gray-700 focus:border-[#00f0ff] rounded-md px-4 py-3 outline-none text-sm transition-colors disabled:opacity-50"
                />
                <button 
                  type="submit"
                  disabled={!inputMessage.trim() || isThinking || isGeneratingSummary}
                  className="px-6 py-3 bg-[#00f0ff] text-[#0b0f19] font-bold rounded-md hover:shadow-[0_0_15px_#00f0ff] transition-all disabled:opacity-50"
                >
                  &gt;
                </button>
              </form>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
