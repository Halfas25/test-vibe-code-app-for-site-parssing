<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebMind - AI Web Scanner</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#0b0f19] text-[#e2e8f0] m-0">
  
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const FontImport = () => (
      <style>
        {`
          @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
          body { font-family: 'JetBrains Mono', monospace; }
          
          .thinking-dots::after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
          }
          @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: #00f0ff; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 #00f0ff, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 #00f0ff, .5em 0 0 #00f0ff; }
          }
        `}
      </style>
    );

    const formatInline = (text) => {
      const parts = text.split(/(\*\*.*?\*\*)/g);
      return parts.map((part, i) => {
        if (part.startsWith('**') && part.endsWith('**')) {
          return <strong key={i} className="text-white">{part.slice(2, -2)}</strong>;
        }
        return part;
      });
    };

    const formatMarkdown = (text) => {
      if (!text) return null;
      const lines = text.split('\n');
      return lines.map((line, i) => {
        const trimmed = line.trim();
        if (trimmed === '---') {
          return <hr key={i} className="border-[#00f0ff]/30 my-5 shadow-[0_0_10px_rgba(0,240,255,0.2)]" />;
        }
        if (trimmed.startsWith('# ')) {
          return <h1 key={i} className="text-xl font-bold text-[#00f0ff] mb-4 mt-2 drop-shadow-[0_0_5px_rgba(0,240,255,0.5)]">{formatInline(trimmed.slice(2))}</h1>;
        }
        if (trimmed.startsWith('> ')) {
          return <blockquote key={i} className="border-l-4 border-[#00f0ff] bg-[#00f0ff]/10 p-4 rounded-r italic text-gray-200 my-4 shadow-inner">{formatInline(trimmed.slice(2))}</blockquote>;
        }
        return <div key={i} className="mb-2 leading-relaxed">{formatInline(line)}</div>;
      });
    };

    function App() {
      const [url, setUrl] = useState('');
      const [stage, setStage] = useState('input');
      const [progress, setProgress] = useState(0);
      const [messages, setMessages] = useState([]);
      const [inputMessage, setInputMessage] = useState('');
      
      const [siteContent, setSiteContent] = useState('');
      const [error, setError] = useState(null);
      const [isThinking, setIsThinking] = useState(false);
      const [isGeneratingSummary, setIsGeneratingSummary] = useState(false);

      const [showSettings, setShowSettings] = useState(false);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('webmind_api_key') || '');

      const messagesEndRef = useRef(null);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages, isThinking, isGeneratingSummary]);

      const saveApiKey = (key) => {
        setApiKey(key);
        localStorage.setItem('webmind_api_key', key);
      };

      const generateAutoSummary = async (text, currentUrl) => {
        setIsGeneratingSummary(true);
        try {
          const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: 'google/gemini-2.0-flash-001',
              messages: [
                { 
                  role: 'system', 
                  content: `–¢—ã ‚Äî –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò-–∞–Ω–∞–ª–∏—Ç–∏–∫. –°—Ñ–æ—Ä–º–∏—Ä—É–π –æ—Ç—á–µ—Ç –ø–æ —Å–∞–π—Ç—É, –∏—Å–ø–æ–ª—å–∑—É—è —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è:
–ó–∞–≥–æ–ª–æ–≤–æ–∫: # üìë –¶–ò–§–†–û–í–û–ô –°–õ–ï–ü–û–ö: ${currentUrl}
–†–∞–∑–¥–µ–ª–∏ –∫–æ–Ω—Å–ø–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏ —Å –ø–æ–º–æ—â—å—é –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π ---.
–ò—Å–ø–æ–ª—å–∑—É–π –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤.
–°–ø–∏—Å–∫–∏ –¥–µ–ª–∞–π —á–µ—Ä–µ–∑ —ç–º–æ–¥–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚ö° –¥–ª—è —Ñ–∞–∫—Ç–æ–≤, üéØ –¥–ª—è —Ü–µ–ª–µ–π).
–í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å –±–ª–æ–∫ > **–í–µ—Ä–¥–∏–∫—Ç:** [–æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ —Å—É—Ç–∏ —Å–∞–π—Ç–∞].` 
                },
                { role: 'user', content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –∏ –≤—ã–¥–∞–π —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å–ª–µ–ø–æ–∫:\n\n${text.substring(0, 40000)}` }
              ]
            })
          });
          
          const data = await response.json();
          if (data.error) throw new Error(data.error.message);
          
          const aiResponse = data.choices[0].message.content;
          setMessages([{ sender: 'bot', text: aiResponse, isSummary: true }]);
        } catch (err) {
          setMessages([{ sender: 'bot', text: `**–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–µ–ø–∫–∞:**\n${err.message}` }]);
        } finally {
          setIsGeneratingSummary(false);
        }
      };

      const startScanning = async () => {
        if (!url.trim()) return;
        setStage('scanning');
        setProgress(0);
        setError(null);

        const progressInterval = setInterval(() => {
          setProgress((prev) => (prev < 90 ? prev + Math.floor(Math.random() * 10) + 2 : prev));
        }, 300);

        try {
          let rawHtml = '';
          let cleanText = '';
          const encodedUrl = encodeURIComponent(url);

          try {
            // –ü–æ–ø—ã—Ç–∫–∞ 1: corsproxy.io (–ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏)
            const response1 = await fetch('https://corsproxy.io/?' + encodedUrl);
            if (!response1.ok) throw new Error('Corsproxy failed');
            rawHtml = await response1.text();
          } catch (err1) {
            console.warn("–ü–µ—Ä–≤—ã–π –ø—Ä–æ–∫—Å–∏ –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è, –ø—Ä–æ–±—É–µ–º AllOrigins...", err1);
            // –ü–æ–ø—ã—Ç–∫–∞ 2: AllOrigins
            try {
              const response2 = await fetch('https://api.allorigins.win/get?url=' + encodedUrl);
              if (!response2.ok) throw new Error('AllOrigins proxy failed');
              const proxyData = await response2.json();
              rawHtml = proxyData.contents;
            } catch (err2) {
              console.warn("–í—Ç–æ—Ä–æ–π –ø—Ä–æ–∫—Å–∏ –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ Jina AI...", err2);
            }
          }

          // –ü–∞—Ä—Å–∏–Ω–≥, –µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ HTML
          if (rawHtml) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(rawHtml, 'text/html');
            const elementsToRemove = doc.querySelectorAll('script, style, svg, noscript, iframe, nav, footer');
            elementsToRemove.forEach(el => el.remove());

            cleanText = doc.body ? doc.body.textContent : doc.textContent;
            cleanText = cleanText.replace(/\s+/g, ' ').trim();
          }

          // –î–ï–¢–ï–ö–¢–û–† –ë–õ–û–ö–ò–†–û–í–û–ö (–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –í–∏–∫–∏–ø–µ–¥–∏—é –∏–ª–∏ Cloudflare)
          if (!cleanText || cleanText.includes('w.wiki/4wJS') || cleanText.includes('Just a moment...')) {
            console.warn("–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∞–Ω—Ç–∏-–±–æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞. –ü–æ–¥–∫–ª—é—á–∞—é —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–∞–Ω–∞–ª Jina AI...");
            // –ü–æ–ø—ã—Ç–∫–∞ 3 (–†–µ–∑–µ—Ä–≤ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–∞–π—Ç–æ–≤): r.jina.ai
            const response3 = await fetch('https://r.jina.ai/' + url, {
              headers: { 'Accept': 'application/json', 'X-Return-Format': 'markdown' }
            });
            if (!response3.ok) throw new Error('–í—Å–µ –º–µ—Ç–æ–¥—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å');
            const data3 = await response3.json();
            cleanText = data3.data?.content || data3.content || data3.text || '';
          }

          if (!cleanText || cleanText.trim() === '') throw new Error('–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç');

          setSiteContent(cleanText);
          clearInterval(progressInterval);
          setProgress(100);

          setTimeout(() => {
            setStage('chat');
            if (apiKey) {
              generateAutoSummary(cleanText, url);
            } else {
              setMessages([
                { sender: 'bot', text: `–ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω (${cleanText.length} —Å–∏–º–≤.).\n\n**–í–Ω–∏–º–∞–Ω–∏–µ:** –£–∫–∞–∂–∏—Ç–µ API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (‚öôÔ∏è), —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–º–Ω—ã–π —Å–ª–µ–ø–æ–∫ —Å–∞–π—Ç–∞.` }
              ]);
            }
          }, 800);

        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏:", error);
          clearInterval(progressInterval);
          setStage('input');
          setError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–æ–π—Ç–∏ –∑–∞—â–∏—Ç—É —Å–∞–π—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL.');
        }
      };

      const askAI = async (userText) => {
        setIsThinking(true);
        try {
          const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: 'google/gemini-2.0-flash-001',
              messages: [
                { 
                  role: 'system', 
                  content: `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç-–ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫—Ä–∞—Ç–∫–æ –∏ –µ–º–∫–æ, –æ–ø–∏—Ä–∞—è—Å—å —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç —Å–∞–π—Ç–∞:\n\n${siteContent.substring(0, 40000)}` 
                },
                { role: 'user', content: userText }
              ]
            })
          });
          
          const data = await response.json();
          if (data.error) throw new Error(data.error.message);
          
          const aiResponse = data.choices[0].message.content;
          setMessages((prev) => [...prev, { sender: 'bot', text: aiResponse }]);
        } catch (err) {
          setMessages((prev) => [...prev, { sender: 'bot', text: `**–û—à–∏–±–∫–∞ API:**\n${err.message}` }]);
        } finally {
          setIsThinking(false);
        }
      };

      const sendMessage = async (e) => {
        e.preventDefault();
        if (!inputMessage.trim() || isThinking || isGeneratingSummary) return;

        const userText = inputMessage;
        setMessages((prev) => [...prev, { sender: 'user', text: userText }]);
        setInputMessage('');

        if (!apiKey) {
          setMessages((prev) => [...prev, { sender: 'bot', text: '–£–∫–∞–∂–∏—Ç–µ API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (‚öôÔ∏è) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤.' }]);
          return;
        }

        await askAI(userText);
      };

      const resetApp = () => {
        setStage('input');
        setUrl('');
        setSiteContent('');
        setMessages([]);
        setError(null);
      };

      return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4 relative">
          <FontImport />

          <header className="absolute top-8 left-8 right-8 flex justify-between items-center z-10">
            <h1 
              className="text-2xl font-bold tracking-widest text-[#00f0ff] drop-shadow-[0_0_8px_rgba(0,240,255,0.8)] cursor-pointer"
              onClick={resetApp}
              title="–ù–∞ –≥–ª–∞–≤–Ω—É—é"
            >
              WEBMIND<span className="animate-pulse">_</span>
            </h1>
            <button 
              onClick={() => setShowSettings(true)}
              className="text-gray-400 hover:text-[#00f0ff] transition-colors p-2"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </button>
          </header>

          {showSettings && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm animate-fade-in">
              <div className="bg-[#111827] border border-[#00f0ff]/50 p-6 rounded-xl w-full max-w-md shadow-[0_0_30px_rgba(0,240,255,0.1)]">
                <h2 className="text-[#00f0ff] text-xl mb-4 uppercase tracking-widest font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-gray-400 text-sm mb-2">OpenRouter API Key:</label>
                    <input
                      type="password"
                      value={apiKey}
                      onChange={(e) => saveApiKey(e.target.value)}
                      placeholder="sk-or-v1-..."
                      className="w-full bg-[#0b0f19] border border-gray-700 focus:border-[#00f0ff] rounded px-4 py-2 text-sm outline-none transition-colors"
                    />
                  </div>
                  <div className="flex justify-end pt-2">
                    <button 
                      onClick={() => setShowSettings(false)}
                      className="px-6 py-2 bg-[#00f0ff] text-[#0b0f19] font-bold rounded hover:shadow-[0_0_10px_#00f0ff] transition-all"
                    >
                      –ì–æ—Ç–æ–≤–æ
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {stage === 'input' && (
            <div className="w-full max-w-xl flex flex-col items-center z-0">
              <input
                type="url"
                placeholder="https://example.com"
                value={url}
                onChange={(e) => setUrl(e.target.value)}
                className={`w-full bg-[#111827] border ${error ? 'border-[#ff003c]' : 'border-gray-700'} focus:border-[#00f0ff] focus:ring-1 focus:ring-[#00f0ff] rounded-md px-6 py-4 text-lg outline-none transition-all shadow-inner`}
                autoFocus
              />
              {error && <div className="mt-4 text-[#ff003c] text-sm tracking-wider font-bold animate-pulse text-center">[!] {error}</div>}
              <button
                onClick={startScanning}
                disabled={!url.trim()}
                className="mt-8 px-10 py-4 bg-transparent border-2 border-[#00f0ff] text-[#00f0ff] font-bold text-lg rounded-md uppercase tracking-wider hover:bg-[#00f0ff] hover:text-[#0b0f19] transition-all duration-300 disabled:opacity-50"
              >
                –ò–∑—É—á–∏—Ç—å —Å–∞–π—Ç
              </button>
            </div>
          )}

          {stage === 'scanning' && (
            <div className="w-full max-w-xl flex flex-col items-center">
              <p className="text-[#00f0ff] mb-4 text-sm uppercase tracking-widest">–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö: {progress}%</p>
              <div className="w-full h-2 bg-gray-800 rounded-full overflow-hidden border border-gray-700">
                <div className="h-full bg-[#00f0ff] transition-all duration-300 ease-out" style={{ width: `${progress}%` }} />
              </div>
            </div>
          )}

          {stage === 'chat' && (
            <div className="w-full max-w-4xl h-[80vh] bg-[#111827] border border-gray-800 rounded-xl flex flex-col shadow-2xl mt-8">
              <div className="flex-1 overflow-y-auto p-6 space-y-6">
                
                {isGeneratingSummary && (
                  <div className="flex justify-start">
                    <div className="max-w-[80%] px-6 py-4 rounded-lg bg-[#00f0ff]/5 border border-[#00f0ff] shadow-[0_0_15px_rgba(0,240,255,0.2)] text-[#00f0ff] font-bold tracking-widest text-sm animate-pulse">
                      –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—é –¥–∞–Ω–Ω—ã–µ... üü©üü©üü©‚¨ú‚¨ú
                    </div>
                  </div>
                )}

                {messages.map((msg, idx) => (
                  <div key={idx} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[90%] px-6 py-4 rounded-lg text-sm ${
                      msg.sender === 'user' 
                        ? 'bg-gray-800 text-gray-100 border border-gray-700' 
                        : msg.isSummary 
                          ? 'bg-[#00f0ff]/5 border-2 border-[#00f0ff] shadow-[0_0_20px_rgba(0,240,255,0.15)] text-[#e2e8f0]' 
                          : 'bg-[#00f0ff]/10 border border-[#00f0ff]/30 text-[#e2e8f0]'
                    }`}>
                      {formatMarkdown(msg.text)}
                    </div>
                  </div>
                ))}
                
                {isThinking && (
                  <div className="flex justify-start">
                    <div className="max-w-[80%] px-5 py-3 rounded-lg text-sm bg-[#00f0ff]/5 border border-[#00f0ff]/20 text-[#00f0ff]">
                      <span className="opacity-80">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–ø—Ä–æ—Å</span>
                      <span className="thinking-dots"></span>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>

              <form onSubmit={sendMessage} className="p-4 border-t border-gray-800 bg-[#0b0f19] rounded-b-xl flex gap-3">
                <input
                  type="text"
                  placeholder="–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª—É..."
                  value={inputMessage}
                  onChange={(e) => setInputMessage(e.target.value)}
                  disabled={isThinking || isGeneratingSummary}
                  className="flex-1 bg-transparent border border-gray-700 focus:border-[#00f0ff] rounded-md px-4 py-3 outline-none text-sm transition-colors disabled:opacity-50"
                />
                <button 
                  type="submit"
                  disabled={!inputMessage.trim() || isThinking || isGeneratingSummary}
                  className="px-6 py-3 bg-[#00f0ff] text-[#0b0f19] font-bold rounded-md hover:shadow-[0_0_15px_#00f0ff] transition-all disabled:opacity-50"
                >
                  &gt;
                </button>
              </form>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
